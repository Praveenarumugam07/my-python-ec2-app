version: 0.2

env:
  variables:
    CODEARTIFACT_DOMAIN: "pr-domain"          # your CodeArtifact domain
    CODEARTIFACT_REPO: "pr-repository"        # your CodeArtifact repository
    REGION: "ap-south-1"                      # your AWS region
    DOMAIN_OWNER: "337243655832"              # your AWS account ID
    EC2_PUBLIC_IP: "3.110.130.25"             # replace with your EC2 public IP
    EC2_USER: "ec2-user"                      # use 'ec2-user' for Amazon Linux; 'ubuntu' for Ubuntu AMIs
    PARAM_NAME: "praveen-ec2-key"             # your SSM parameter name storing .pem key
    PACKAGE_NAME: "my-python-ec2-app"         # your Python package name

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "ðŸ”§ Installing build tools..."
      - pip install --upgrade pip
      - pip install build twine

  pre_build:
    commands:
      - echo "ðŸ”Ž DEBUG: CODEARTIFACT_REPO=$CODEARTIFACT_REPO"
      - echo "ðŸ”Ž DEBUG: CODEARTIFACT_DOMAIN=$CODEARTIFACT_DOMAIN"
      - echo "ðŸ”Ž DEBUG: DOMAIN_OWNER=$DOMAIN_OWNER"
      - echo "ðŸ”Ž DEBUG: REGION=$REGION"
      - echo "ðŸ” Authenticating to CodeArtifact..."
      - aws codeartifact login --tool twine \
          --repository $CODEARTIFACT_REPO \
          --domain $CODEARTIFACT_DOMAIN \
          --domain-owner $DOMAIN_OWNER \
          --region $REGION

  build:
    commands:
      - echo "âš™ï¸ Building Python package..."
      - python -m build

  post_build:
    commands:
      - echo "ðŸ”‘ Fetching CodeArtifact authorization token..."
      - export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
          --domain $CODEARTIFACT_DOMAIN \
          --domain-owner $DOMAIN_OWNER \
          --region $REGION \
          --query authorizationToken \
          --output text)

      - echo "ðŸš€ Uploading package to CodeArtifact..."
      - twine upload --repository-url https://$CODEARTIFACT_DOMAIN-$DOMAIN_OWNER.d.codeartifact.$REGION.amazonaws.com/pypi/$CODEARTIFACT_REPO/ \
          -u aws -p $CODEARTIFACT_AUTH_TOKEN dist/*

      - echo "ðŸ” Fetching SSH key from SSM Parameter Store..."
      - aws ssm get-parameter --name "$PARAM_NAME" --with-decryption --query Parameter.Value --output text > key.pem
      - chmod 400 key.pem

      - echo "ðŸ’» Deploying to EC2 and installing package from CodeArtifact..."
      - |
        ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_PUBLIC_IP << 'EOF'
          echo "ðŸ”§ Installing AWS CLI and pip on EC2 if not present..."
          if ! command -v aws &> /dev/null; then
            sudo yum install -y awscli || sudo apt install -y awscli
          fi
          if ! command -v pip &> /dev/null; then
            sudo yum install -y python3-pip || sudo apt install -y python3-pip
          fi

          echo "ðŸ”‘ Authenticating to CodeArtifact from EC2..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain $CODEARTIFACT_DOMAIN \
            --domain-owner $DOMAIN_OWNER \
            --region $REGION \
            --query authorizationToken \
            --output text)

          echo "ðŸ“¦ Installing your package from CodeArtifact..."
          pip install --extra-index-url https://$CODEARTIFACT_DOMAIN-$DOMAIN_OWNER.d.codeartifact.$REGION.amazonaws.com/pypi/$CODEARTIFACT_REPO/simple/ $PACKAGE_NAME

          echo "âœ… Deployment completed on EC2."
        EOF

artifacts:
  files:
    - '**/*'
